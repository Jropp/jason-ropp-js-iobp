<!-- bplint-disable no-unused-import -->
<link rel="import" href="~@banno/polymer/lib/elements/dom-if.js">
<link rel="import" href="~@banno/polymer/lib/elements/dom-repeat.js">
<!-- bplint-enable no-unused-import -->
<link rel="import" href="../user-component/user-component.html">
<dom-module id="user-list">
  <template>
    <style>
      :host {
        display: block;
        background-color: #e4e7ea;
      }

      .columns {
        display: grid;
        grid-template-columns: 1fr 500px 1fr;
      }

      .options-bar {
        height: 100px;
      }

      .dropdown-container {
        position: relative;
        margin-left: 25px;
        display: inline-block;
        vertical-align: top;
        width: 42%;
        background-color: #3e3a3a;
        border-radius: 3px;
        box-shadow: rgba(0, 0, 0, 0.14902) 0px 1px 1px 0px, rgba(0, 0, 0, 0.09804) 0px 1px 2px 0px;
        cursor: default;
      }

      .sort-direction-container {
        vertical-align: top;
        width: 42%;
        background-color: #3e3a3a;
        border-radius: 3px;
        box-shadow: rgba(0, 0, 0, 0.14902) 0px 1px 1px 0px, rgba(0, 0, 0, 0.09804) 0px 1px 2px 0px;
      }

      .dropdown-container>.dropdown-header {
        margin: 10px;
        display: inline-block;
        font-weight: bold;
        color: white;
        margin-right: 5px;
      }

      .dropdown-container>hr {
        margin: 0px 10px 0px 10px;
        background-color: white;
        height: .5px;
        opacity: 0;
        transition: opacity .3s;
      }

      .dropdown-container:hover>hr {
        margin-bottom: 5px;
        opacity: 1;
        transition: opacity .2s;
      }

      .dropdown-container:hover>.dropdown-options {
        height: 80px;
        transition: height .3s;
        opacity: 1;
      }

      .dropdown-container:hover>.sort-direction-options {
        height: 50px;
      }

      .dropdown-container:hover>.dropdown-options>li {
        list-style: none;
        opacity: 1;
        transition: opacity .2s .2s;
      }

      .dropdown-options {
        background-color: #3e3a3a;
        height: 0px;
        transition: height .4s;
      }

      .dropdown-options>li {
        margin-left: 10px;
        margin-bottom: 3px;
        color: white;
        margin-right: 10px;
        list-style: none;
        opacity: 0;
      }

      li:hover {
        text-decoration: underline;
        margin-bottom: 2;
        cursor: pointer;
      }

      li:active {
        color: gray;
      }

      .user-list-row {
        text-align: center;
        margin-top: 18px;
      }

      .card-container {
        display: flex;
        flex-direction: column;
      }

      .message-box {
        background-color: #455564;
        color: #eef1f4;
        position: fixed;
        bottom: 10px;
        left: 10px;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 16px;
        height: auto;
        width: 250px;
        margin: 20px;
        padding: 10px;
        text-align: left;
        opacity: 0;
        transform: translateY(100%);
        transition: all 600ms cubic-bezier(0.77, 0, 0.175, 1);
        z-index: 1;
      }

      .show-message {
        transform: none;
        opacity: 0.9;
      }

      .no-users {
        background-color: white;
        padding: 18px;
        font-size: 17px;
        font-family: Arial, Helvetica, sans-serif;
        border-radius: 3px;
        box-shadow: rgba(0, 0, 0, 0.14902) 0px 1px 1px 0px, rgba(0, 0, 0, 0.09804) 0px 1px 2px 0px;
      }

      .category-header {
        position: relative;
        margin: 50px 0px 40px 0px;
        left: -30px;
        border-bottom: black solid 2px;
        width: calc(100%+20px);
      }

      .category-header>.category-text {
        position: absolute;
        bottom: 10px;
        left: 10px;
      }
    </style>
    <div class="columns">
      <div class="column-1">
        <h2 id="popupBox" class="message-box">Save</h2>
      </div>
      <div class="card-container column-2">
        <div class="create-user-row">
          <user-component class="new-user-card" edit-open="[[editInProgress]]"></user-component>
          <div class="options-bar">
            <div class="dropdown-container">
              <div class="dropdown-header">Sort Users By:
              </div>
              <hr>
              <div class="dropdown-options">
                <li id="last" on-click="dropdownSort">Last
                  <template is="dom-if" if="[[sortIs(sortCategories.LAST_NAME, currentSortCategory)]]">
                    ✓
                  </template>
                </li>
                <li id="first" on-click="dropdownSort">First
                  <template is="dom-if" if="[[sortIs(sortCategories.FIRST_NAME, currentSortCategory)]]">
                    ✓
                  </template>
                </li>
                <li id="department" on-click="dropdownSort">Department
                  <template is="dom-if" if="[[sortIs(sortCategories.DEPARTMENT, currentSortCategory)]]">
                    ✓
                  </template>
                </li>
              </div>
            </div>
            <div class="sort-direction-container dropdown-container">
              <div class="dropdown-header">Sort Direction:</div>
              <hr>
              <div class="sort-direction-options dropdown-options">
                <li id="sortAlphabetical" on-click="sortByDirection">A-Z
                  <template is="dom-if" if="[[!sortDirectionIsReversed]]">
                    ✓
                  </template>
                </li>
                <li id="sortReversedAlphabetical" on-click="sortByDirection">Z-A
                  <template is="dom-if" if="[[sortDirectionIsReversed]]">
                    ✓
                  </template>
                </li>
              </div>
            </div>
          </div>
        </div>
        <div class="user-list-row">
          <template is="dom-if" if="[[noUsersHeaderMessage(users)]]">
            <div class="no-users">
              <p>There aren't any users in the database at the moment. Would you mind creating one to get started?</p>
            </div>
          </template>
          <template is="dom-repeat" items="[[users]]" as="user">
            <template is="dom-if" if="[[setDisplayOfSortHeader(users, index, currentSortCategory)]]">
              <div class="category-header">
                <div class="category-text">[[setNewGroupHeader(user, index, users)]]</div>
              </div>
            </template>
            <user-component edit-open="[[editInProgress]]" is-expanded="[[isUserCardDisplayExpanded(user.id, users, expandedCardIds)]]"
              user-to-display="[[user]]"></user-component>
          </template>
        </div>
      </div>
      <div class="colum-3"></div>
    </div>

  </template>
  <script type="module">

    import { Element as PolymerElement } from '@banno/polymer/polymer-element.js'; // eslint-disable-line no-unused-vars
    import { Database } from './../api/user-database.js';

    class UserListElement extends PolymerElement {
      static get is() { return 'user-list'; }
      static get properties() {
        return {
          editInProgress: {
            type: Boolean,
            value: false
          },
          expandedCardIds: {
            type: Array,
            value: []
          },
          sortCategories: {
            type: Object,
            value: () => {
              return {
                FIRST_NAME: 'first',
                LAST_NAME: 'last',
                DEPARTMENT: 'department'
              };
            }
          },
          currentSortCategory: {
            type: String,
            value: 'last'
          },
          sortDirectionIsReversed: {
            type: Boolean,
            value: false
          },
          users: {
            type: Array,
            value: () => Database.getUsersSortedBy(['last', 'first', 'department'])
          }
        };
      }
      connectedCallback() {
        super.connectedCallback();

        document.addEventListener('cancel', () => {
          this.toggleMode();
        });

        document.addEventListener('databaseUpdated', e => {
          this.setSortedUsersBy(this.currentSortCategory);
          this.popupMessage(e.detail.message);
          this.resetExpandedCardIds(e.detail.message === 'Edit Save');
        });

        document.addEventListener('editInProgress', e => {
          this.editInProgress = e.detail;
        });

        document.addEventListener('cardDetailDisplayChanged', (e) => {
          const id = e.detail.id;
          let cardIsExpanded = e.detail.expanded;
          return cardIsExpanded ? this.addIdToExpandedList(id) : this.removeIdFromExpandedList(id);
        });
      }

      dropdownSort(e) {
        this.setSortedUsersBy(e.target.id);
        this.resetExpandedCardIds(true);
      }

      setSortedUsersBy(sortFirstBy) {
        let sortBy = this.getSortArray(sortFirstBy);

        this.currentSortCategory = sortFirstBy;
        let reversedSort = this.sortDirectionIsReversed;
        this.users = reversedSort ? Database.getUsersSortedBy(sortBy).reverse() : Database.getUsersSortedBy(sortBy);
      }

      getSortArray(sortFirstBy) {
        let firstName = this.sortCategories.FIRST_NAME;
        let lastName = this.sortCategories.LAST_NAME;
        let department = this.sortCategories.DEPARTMENT;

        if (sortFirstBy === lastName) {
          return [lastName, firstName, department];
        }
        if (sortFirstBy === firstName) {
          return [firstName, lastName, department];
        }
        if (sortFirstBy === department) {
          return [department, firstName, lastName];
        }
      }

      sortByDirection(e) {
        this.sortDirectionIsReversed = e.target.id === 'sortReversedAlphabetical';
        this.setSortedUsersBy(this.currentSortCategory);
        this.resetExpandedCardIds(true);
      }

      resetExpandedCardIds(reset) {
        if (reset) {
          this.expandedCardIds = [];
        } else {
          this.expandedCardIds = this.expandedCardIds;
        }
      }

      addIdToExpandedList(id) {
        this.expandedCardIds.splice(0, 0, id);
      }

      removeIdFromExpandedList(idToDelete) {
        let idIndex = this.expandedCardIds.findIndex(id => {
          return id === idToDelete;
        });

        this.expandedCardIds.splice(idIndex, 1);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        document.removeEventListener('editInProgress');
        document.removeEventListener('databaseUpdated');
        document.removeEventListener('cancel');
      }

      noUsersHeaderMessage(users) {
        return !users.length;
      }

      popupMessage(action) {
        let animationTime = 3000;
        let messageBox = this.$.popupBox;
        messageBox.textContent = action + ' Successful';
        messageBox.className = 'message-box show-message ' + action;
        window.setTimeout(() => {
          messageBox.className = 'message-box';
        }, animationTime);
      }

      isUserCardDisplayExpanded(userId) {
        let isExpanded = false;
        this.expandedCardIds.forEach(id => {
          if (id === userId) {

            isExpanded = true;
          }
        });

        return isExpanded;
      }

      setDisplayOfSortHeader(users, index) {
        let previousUser = users[index - 1];
        let currentUser = users[index];
        let sortCategory = this.currentSortCategory || this.sortCategories.LAST_NAME;

        let deletingLastUser = !previousUser || !currentUser;

        if (!previousUser || deletingLastUser) {
          return true;
        } else {

          let insertNewCategoryHeader = this.compareCatLetterWithPreviousUser(previousUser, currentUser, sortCategory);

          return insertNewCategoryHeader;
        }
      }

      compareCatLetterWithPreviousUser(previous, current, sortCategory) {
        let compareWholeWord = prevoius[sortCategory] !== current[sortCategory];
        let compareFirstLetter = this.firstLetterOf(previous[sortCategory]) !== this.firstLetterOf(current[sortCategory]);

        let insertNewCategoryHeader = this.categoryIsFirstOrLastName() ? compareWholeWord : compareFirstLetter;

        return insertNewCategoryHeader;
      }

      categoryIsFirstOrLastName() {
        let isFirstName = this.sortIs(this.sortCategories.FIRST_NAME, this.currentSortCategory);
        let isLastName = this.sortIs(this.sortCategories.LAST_NAME, this.currentSortCategory);

        return isFirstName || isLastName;
      }

      firstLetterOf(wordToSlice) {
        return wordToSlice.slice(0, 1);
      }

      sortIs(expectedSortCategory, currentSortCategory) {
        return expectedSortCategory === currentSortCategory
      }

      setNewGroupHeader(user, index, users) {
        let category = this.currentSortCategory || this.sortCategories.LAST_NAME;

        return this.sortCategoryIsFirstOrLast() ? `${this.firstLetterOf(user[category])}` : `${user[category]}`;
      }
    }

    customElements.define(UserListElement.is, UserListElement);
    export default UserListElement;
  </script>
</dom-module>
