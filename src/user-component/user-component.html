<!-- bplint-disable no-unused-import -->
<link rel="import" href="~@banno/polymer/lib/elements/dom-if.js">
<link rel="import" href="~@banno/polymer/polymer-element.js">
<!-- bplint-enable no-unused-import -->

<dom-module id="user-component">
  <template>
    <style>
      :host {
        display: block;
        font-family: Arial, Helvetica, sans-serif;
        --primary-color: white;
        --secondary-color: #0070b7;
        --tertiary-color: #fca902;
        --warning-color: red;
      }

      .default-card {
        width: 500px;
        height: 'auto';
        margin: 5px;
        padding: 15px;
        border: var(--secondary-color) 1px solid;
        border-radius: 5px;
        box-shadow: 3px 3px 2px lightgrey;
        background-color: var(--primary-color);
      }

      .visible {
        animation: expand .4s;
        height: auto;
      }

      .visible>* {
        animation: fade-in .5s;
      }

      .hidden {
        animation: collapse .4s;
        opacity: 0;
        transition: opacity .4s, width .5s, height .5s;
      }

      .hidden>* {
        opacity: 0;
        transition: width .4s, height .4s;
      }

      fieldset {
        margin: 10px;
        border-radius: 3px;
        border: var(--secondary-color) 2px solid;
      }

      .default-card>input .first-name .last-name {
        width: 20px;
      }

      input {
        width: auto;
        margin: 5px;
        border: none;
        font-size: 20px;
      }

      .first-name {
        width: 150px;
      }

      .last-name {
        width: 150px;
      }

      .edit {
        border-bottom: lightgray solid 1px;
      }

      .email {
        width: 50%;
      }

      .id {
        margin-top: -25px;
      }

      .id>* {
        display: inline-block;
        font-size: 14px;
      }

      button {
        margin: 10px;
        margin-top: 20px;
        width: 60px;
        height: 30px;
        border-radius: 3px;
        box-shadow: 1px 1px 1px lightgrey;
      }

      .warning {
        color: var(--warning-color);
        font-size: 20px;
      }

      @keyframes expand {
        0% {
          height: 0px;
          width: 0px;
        }
        100% {
          height: 340px;
          width: 500px;
        }
      }

      @keyframes collapse {
        0% {
          height: 340px;
          width: 500px;
        }
        100% {
          height: 0px;
          width: 0px;
        }
      }

      @keyframes fade-in {
        0% {
          opacity: 0;
        }
        50% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }
    </style>

    <div id="userCard" class="default-card">
      <form on-input="formWatcher" autocomplete="on">
        <h1>[[headerMessage(mode)]]</h1>
        <!-- bplint-disable no-auto-binding -->
        <template is="dom-if" if="[[isMode(modes.EDIT, mode)]]">
          <fieldset>
            <label for="firstName">First:</label>
            <input id="firstName" type="text" class="first-name edit" placeholder="First" autocomplete="given-name" value="{{user.first::change}}"
              required>

            <label for="lastName">Last:</label>
            <input id="lastName" type="text" class="last-name edit" placeholder="Last" autocomplete="family-name" value="{{user.last::change}}"
              required>
          </fieldset>
        </template>
        <template is="dom-if" if="[[isMode(modes.DISPLAY, mode)]]">
          <h1>[[user.last]], [[user.first]]</h1>
          <div class="id" id="id">
            <h3>ID:</h3>
            <p class="id">[[user.id]]</p>
          </div>
        </template>

        <fieldset>
          <label for="email">Email:</label>
          <input id="email" type="email" on-blur="formWatcher" class="email edit" placeholder="email" autocomplete="email" value="{{user.email::change}}"
            name="email" required>
          <br>

          <template is="dom-if" if="[[displayEmailFormatMessage]]">
            <p class="warning">[[emailFormatMessage]]</p>
          </template>

          <label for="phone">Phone:</label>
          <input id="phone" type="tel" on-blur="formWatcher" class="phone edit" placeholder="(xxx) xxx-xxxx" autocomplete="tel" value="{{user.phone::change}}"
            required>
          <br>

          <template is="dom-if" if="[[displayPhoneFormatMessage]]">
            <p class="warning">[[phoneFormatMessage]]</p>
          </template>

          <label for="department">Department:</label>
          <input id="department" class="department edit" placeholder="Department" value="{{user.department::change}}" required/>
        </fieldset>

        <!-- bplint-enable no-auto-binding -->
        <div class="submit-button-box">

          <template is="dom-if" if="[[isMode(modes.EDIT, mode)]]">
            <button on-click="save" type="submit" disabled="[[disableSave]]">Save</button>

            <template is="dom-if" if="[[user.id]]">
              <button on-click="delete" type="submit" formnovalidate>Delete</button>
            </template>

            <template is="dom-if" if="[[!user.id]]">
              <button on-click="cancel" formnovalidate>Cancel</button>
            </template>

            <template is="dom-if" if="[[displayOpenEditMessage]]">
              <p class="warning">[[openEditMessage]]</p>
            </template>


          </template>

          <template is="dom-if" if="[[isMode(modes.DISPLAY, mode)]]">
            <button on-click="editButtonClicked" type="submit" disabled="[[editOpen]]">Edit</button>
          </template>

        </div>

      </form>
    </div>
  </template>
  <script type="module">
    import { Element as PolymerElement } from '@banno/polymer/polymer-element.js'; // eslint-disable-line no-unused-vars
    import { database } from './../api/user-database.js';
    import ValidateUtil from './../api/utils.js';
    class UserComponentElement extends PolymerElement {
      static get is() { return 'user-component'; }
      static get properties() {
        return {
          // edit, display
          mode: {
            type: String,
          },
          modes: {
            type: Object,
            value: () => {
              return {
                DISPLAY: 'display',
                EDIT: 'edit'
              };
            }
          },
          users: {
            type: Object,
            value: () => database.getUsers()
          },
          user: {
            type: Object,
            value: () => {
              return {
                first: '',
                last: '',
                phone: '',
                email: '',
                department: '',
                id: ''
              };
            }
          },
          disableSave: {
            type: Boolean,
            value: true,
          },
          editOpen: {
            type: Boolean,
            value: false,
            observer: 'formWatcher'
          },
          displayOpenEditMessage: {
            type: Boolean,
          },
          displayPhoneFormatMessage: {
            type: Boolean,
          },
          displayEmailFormatMessage: {
            type: Boolean,
          },
          isVisible: {
            type: Boolean,
            observer: 'toggleNewUserCardDisplay'
          },
          openEditMessage: {
            type: String,
            value: 'Please save other user edits before saving this one.'
          },
          phoneFormatMessage: {
            type: String,
            value: 'Please format phone number as (xxx) xxx-xxxx'
          },
          emailFormatMessage: {
            type: String,
            value: 'Please format email input as xxxx@xxxxx.xxx'
          },
          userToDisplay: {
            type: Object,
            observer: 'formatUserData'
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        if (this.user.id) {
          this.initDisplayCard();
        } else {
          if (this.users.length) {
            this.toggleNewUserCardDisplay();
          }
        }
        this.updateWarningMessages();
      }

      initDisplayCard() {
        if (this.isMode(this.modes.DISPLAY)) {
          this.toggleEditable();
        }
        this.warningMessage = '';
      }

      cancel(e) {
        e.preventDefault();

        this.dispatchEvent(new CustomEvent('cancel', {
          bubbles: true,
          composed: true,
        }));

        this.shadowRoot.querySelector('form').reset();
        this.resetAllMessages();
      }

      fieldsFilled() {
        let fields = this.shadowRoot.querySelectorAll('input');
        let fieldsFilled = true;

        fields.forEach(field => {
          if (!field.value.length) {
            fieldsFilled = false;
            return; // eslint-disable-line no-useless-return
          }
        });

        return fieldsFilled;
      }

      clearNewUserForm() {
        this.shadowRoot.querySelector('form').reset();
        this.disableSave = true;
      }

      delete(e) {
        e.preventDefault();
        database.deleteUser(this.user);
        this.editInProgress(false);
        this.mode = this.modes.DISPLAY;
        this.toggleEditable();
      }

      editButtonClicked(e) {
        e.preventDefault();
        this.editInProgress(true);
        this.toggleMode();
      }

      editInProgress(bool) {
        this.dispatchEvent(new CustomEvent('editInProgress', {
          bubbles: true,
          composed: true,
          detail: bool
        }));
      }

      formatUserData(user) {
        if (user.id) {
          user.phone = ValidateUtil.insertPhoneSymbols(user.phone);
          this.user = user;
        }
      }

      formWatcher() {

        let editOpenAndNewUser = this.editOpen && !this.user.id;
        let emptyFields = !this.fieldsFilled();
        let improperPhoneFormat = !ValidateUtil.checkPhoneInput(this.user.phone);

        fa = editOpenAndNewUser || emptyFields || improperPhoneFormat;

        this.updateWarningMessages();
      }

      headerMessage(mode) {
        if (mode === this.modes.EDIT) {
          return this.user.id ? `Edit: ${this.user.first}, ${this.user.last}` : 'Create User:';
        }
        return '';
      }

      isMode(expectedMode) {
        return expectedMode === this.mode;
      }

      resetFormState() {
        this.editInProgress(false);
        let isNewUserCard = !this.user.id;
        let isUserEditCard = this.user.id;

        if (isUserEditCard) {
          this.toggleMode();
        }

        if (isNewUserCard) {
          this.clearNewUserForm();
        }

        this.resetAllMessages();
      }

      resetAllMessages() {
        this.displayEmailFormatMessage = false;
        this.displayPhoneFormatMessage = false;
      }

      save(e) {
        e.preventDefault();

        let user = Object.assign({}, this.user);

        if (user.id) {
          database.editUser(user);
        } else {
          database.saveUser(user);
        }

        this.resetFormState();
      }

      toggleMode(e) {
        this.mode = this.isMode(this.modes.EDIT) ? this.modes.DISPLAY : this.modes.EDIT;
        this.toggleEditable();
      }

      toggleEditable() {
        this.shadowRoot.querySelectorAll('input')
          .forEach(input => {
            let name = input.className;

            input.className = this.isMode(this.modes.DISPLAY) ? name.replace(/\sedit/, '') : name + ' edit';
            input.readOnly = this.isMode(this.modes.DISPLAY);
          });
      }

      toggleNewUserCardDisplay() {
        let card = this.shadowRoot.querySelector('#userCard');
        let name = card.className;
        let regexToReplace = this.isVisible ? /\shidden/ : /\svisible/;
        let newClass = this.isVisible ? ' visible' : ' hidden';
        card.className = regexToReplace.test(name) ? name.replace(regexToReplace, newClass) : card.className + newClass;
      }

      updateWarningMessages() {
        let isNewUser = !this.user.id;
        let emailInProgress = this.user.email;
        let phoneInProgress = this.user.phone;

        if (emailInProgress) {
          this.displayEmailFormatMessage = !ValidateUtil.checkEmailInput(this.user.email);
        }

        if (phoneInProgress) {
          this.displayPhoneFormatMessage = !ValidateUtil.checkPhoneInput(this.user.phone);
        }

        if (isNewUser) {
          this.displayOpenEditMessage = this.editOpen;
        }
      }

      whenEditOpenChanges() {
        this.formWatcher();
      }
    }

    customElements.define(UserComponentElement.is, UserComponentElement);
    export default UserComponentElement;
  </script>
</dom-module>
