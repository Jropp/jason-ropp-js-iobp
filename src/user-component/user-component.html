<!-- bplint-disable no-unused-import -->
<link rel="import" href="~@banno/polymer/lib/elements/dom-if.js">
<link rel="import" href="~@banno/polymer/polymer-element.js">
<!-- bplint-enable no-unused-import -->

<dom-module id="user-component">
  <template>
    <style>
      :host {
        font-family: Arial, Helvetica, sans-serif;
      }

      .default-card {
        position: relative;
        height: auto;
        width: 450px;
        text-align: center;
        margin: 1em auto;
        padding-bottom: 30px;
        border-radius: 5px;
        background-color: white;
        transition: opacity .4s;
        box-shadow: rgba(0, 0, 0, 0.14902) 0px 1px 1px 0px, rgba(0, 0, 0, 0.09804) 0px 1px 2px 0px;
      }

      .user-card-collapsed {
        height: 70px;
        transition: height .4s ease-out;
      }

      .user-card-collapsed>form>* {
        height: 0px;
        opacity: 0;
      }

      .user-card-expanded {
        height: 350px;
        transition: height .4s ease-out;
      }

      .user-card-expanded>form>* {
        height: auto;
        opacity: 1;
        transition: opacity .8s ease-in;
      }


      .user-card-expanded>.expand-details-clickable {
        background-color: #0070b7;
        color: white;
        transition: all .5s;
      }

      form {
        margin: auto;
        width: 400px;
      }

      div#userCard.default-card.hidden {
        padding: 0px;
      }

      .default-card {
        transition: opacity .4s, max-height 0.4s linear;
      }

      .visible {
        /* animation: expand .6s; */
        height: auto;
        max-height: 600px;
        animation-fill-mode: forwards;
      }

      .visible>.create-user-button {
        background-color: #0070b7;
        color: white;
        font-size: 40px;
        transition: all .5s;
      }

      .visible>form {
        height: auto;
        animation: fade-in .7s;
      }

      .hidden {
        max-height: 90px;
      }

      .hidden>form {
        visibility: hidden;
        width: 0px;
      }

      input {
        height: 40px;
        width: 100%;
        margin-top: 20px;
        padding-left: 5px;
        border: none;
        outline: none;
        font-size: 20px;
        border-bottom: grey solid 1px;
        display: inline-block;
      }

      input:focus {
        border-bottom: #fca902 solid 2px;
      }

      button:disabled {
        opacity: .3;
      }

      input:read-only {
        border: none;
      }

      .id {
        margin-top: -25px;
      }

      .id>* {
        display: inline-block;
        font-size: 14px;
      }

      .submit-button-box {
        margin: auto;
      }

      button {
        height: 40px;
        width: 175px;
        margin-top: 30px;
        border-radius: 3px;
        background-color: #fca902;
        box-shadow: rgba(0, 0, 0, 0.14902) 0px 1px 1px 0px, rgba(0, 0, 0, 0.09804) 0px 1px 2px 0px;
      }

      .warning {
        color: red;
        font-size: 10px;
      }

      @keyframes expand {
        0% {
          height: 0px;
          width: 0px;
        }
        75% {
          height: 408px;
          width: 450px;
        }
        100% {
          height: auto;
          width: 450px;
        }
      }

      @keyframes collapse {
        0% {
          height: 530px;
          width: 450px;
        }
        100% {
          height: 0px;
          width: 0px;
        }
      }

      @keyframes fade-in {
        0% {
          opacity: 0;
        }
        50% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }

      .create-user-button {
        top: 0px;
        font-size: 20px;
        width: 100%;
        height: 90px;
        margin: 0;
        transition: background-color .2s;
      }

      .expand-details-clickable {
        background-color: #fca902;
        box-sizing: border-box;
        position: absolute;
        height: 25px;
        width: 100%;
        bottom: 0px;
        left: 0px;
        padding: 0px;
      }

      .expand-details-clickable>p {
        position: relative;
        top: -7px;
        font-size: 10px;
        font-weight: bold;
      }
    </style>

    <div id="userCard" class="default-card hidden">
      <template is="dom-if" if="[[isMode(modes.DISPLAY, mode)]]">
        <h1>[[user.last]], [[user.first]]</h1>
        <div class="id" id="id">
          <h3>ID:</h3>
          <p class="id">[[user.id]]</p>
        </div>
      </template>
      <template is="dom-if" if="[[isCreateMode(mode)]]">
        <button on-click="toggleNewUserCardDisplay" class="create-user-button">
          [[headerMessage]]
        </button>
      </template>
      <form on-input="formWatcher" autocomplete="on">
        <!-- bplint-disable no-auto-binding -->
        <template is="dom-if" if="[[isMode(modes.EDIT, mode)]]">
          <label for="firstName"></label>
          <input id="firstName" type="text" class="first-name edit" placeholder="First" autocomplete="given-name" value="{{user.first::change}}"
            required>

          <label for="lastName"></label>
          <input id="lastName" type="text" class="last-name edit" placeholder="Last" autocomplete="family-name" value="{{user.last::change}}"
            required>
        </template>

        <label for="email"></label>
        <input id="email" type="email" on-blur="formWatcher" class="email edit" placeholder="Email" autocomplete="email" value="{{user.email::change}}"
          name="email" required>
        <br>

        <template is="dom-if" if="[[displayEmailFormatMessage]]">
          <p class="warning">[[emailFormatMessage]]</p>
        </template>

        <label for="phone">
          <input id="phone" type="tel" on-blur="formWatcher" class="phone edit" placeholder="Phone" autocomplete="tel" value="{{user.phone::change}}"
            required>
        </label>
        <br>

        <template is="dom-if" if="[[displayPhoneFormatMessage]]">
          <p class="warning">[[phoneFormatMessage]]</p>
        </template>

        <label for="department"></label>
        <input id="department" class="department edit" placeholder="Department" value="{{user.department::change}}" required/>

        <!-- bplint-enable no-auto-binding -->
        <div class="submit-button-box">

          <template is="dom-if" if="[[isMode(modes.EDIT, mode)]]">
            <button on-click="save" type="submit" disabled="[[disableSave]]">Save</button>

            <template is="dom-if" if="[[user.id]]">
              <button on-click="delete" type="submit" formnovalidate>Delete</button>
            </template>

            <!-- <template is="dom-if" if="[[!user.id]]">
              <button on-click="cancel" formnovalidate>Cancel</button>
            </template> -->

            <template is="dom-if" if="[[displayOpenEditMessage]]">
              <p class="warning">[[openEditMessage]]</p>
            </template>


          </template>
          <template is="dom-if" if="[[isMode(modes.DISPLAY, mode)]]">
            <button on-click="editButtonClicked" type="submit" disabled="[[editOpen]]">Edit</button>
          </template>
        </div>
      </form>
      <template is="dom-if" if="[[isMode(modes.DISPLAY, mode)]]">
        <div id="detailsButton" on-click="toggleUserCardCollapse" class="expand-details-clickable">
          <p>v</p>
        </div>
      </template>
    </div>
  </template>
  <script type="module">
    import { Element as PolymerElement } from '@banno/polymer/polymer-element.js'; // eslint-disable-line no-unused-vars
    import { database } from './../api/user-database.js';
    import ValidateUtil from './../api/utils.js';
    class UserComponentElement extends PolymerElement {
      static get is() { return 'user-component'; }
      static get properties() {
        return {
          // edit, display
          mode: {
            type: String,
          },
          modes: {
            type: Object,
            value: () => {
              return {
                DISPLAY: 'display',
                EDIT: 'edit',
                CREATE: 'create'
              };
            }
          },
          users: {
            type: Object,
            value: () => database.getUsers()
          },
          user: {
            type: Object,
            value: () => {
              return {
                first: '',
                last: '',
                phone: '',
                email: '',
                department: '',
                id: ''
              };
            }
          },
          disableSave: {
            type: Boolean,
            value: true,
          },
          editOpen: {
            type: Boolean,
            value: false,
            observer: 'formWatcher'
          },
          displayOpenEditMessage: {
            type: Boolean,
          },
          displayPhoneFormatMessage: {
            type: Boolean,
          },
          displayEmailFormatMessage: {
            type: Boolean,
          },
          openEditMessage: {
            type: String,
            value: 'Please save other user edits before saving this one.'
          },
          phoneFormatMessage: {
            type: String,
            value: 'Please format phone number as (xxx) xxx-xxxx'
          },
          emailFormatMessage: {
            type: String,
            value: 'Please format email input as xxxx@xxxxx.xxx'
          },
          headerMessage: {
            type: String,
            value: "Create New User"
          },
          userToDisplay: {
            type: Object,
            observer: 'formatUserData'
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        if (this.user.id) {
          this.initDisplayCard();
        } else if (this.users.length) {
          this.$.userCard.className = 'default-card hidden';
        }
        this.updateWarningMessages();
      }

      initDisplayCard() {
        if (this.isMode(this.modes.DISPLAY)) {
          this.toggleEditable();
          this.$.userCard.className = 'default-card user-card-collapsed';
        }
        this.warningMessage = '';
      }

      cancel() {
        this.shadowRoot.querySelector('form').reset();
        this.resetAllMessages();
      }

      fieldsFilled() {
        let fields = this.shadowRoot.querySelectorAll('input');
        let fieldsFilled = true;

        fields.forEach(field => {
          if (!field.value.length) {
            fieldsFilled = false;
            return; // eslint-disable-line no-useless-return
          }
        });

        return fieldsFilled;
      }

      clearNewUserForm() {
        this.shadowRoot.querySelector('form').reset();
        this.disableSave = true;
      }

      delete(e) {
        e.preventDefault();
        database.deleteUser(this.user);
        this.editInProgress(false);
        this.mode = this.modes.DISPLAY;
        this.toggleEditable();
        this.resetAllMessages();
      }

      editButtonClicked(e) {
        e.preventDefault();
        this.editInProgress(true);
        this.mode = this.modes.EDIT;
        this.toggleEditable();
      }

      editInProgress(bool) {
        this.dispatchEvent(new CustomEvent('editInProgress', {
          bubbles: true,
          composed: true,
          detail: bool
        }));
      }

      formatUserData(user) {
        user.phone = ValidateUtil.insertPhoneSymbols(user.phone);
        this.user = user;
      }

      formWatcher() {

        let editOpenAndNewUser = this.editOpen && !this.user.id;
        let emptyFields = !this.fieldsFilled();
        let improperPhoneFormat = !ValidateUtil.checkPhoneInput(this.user.phone);
        let improperEmailFormat = !ValidateUtil.checkEmailInput(this.user.email);

        this.disableSave = editOpenAndNewUser || emptyFields || improperPhoneFormat || improperEmailFormat;

        this.updateWarningMessages();
      }

      isMode(expectedMode) {
        return expectedMode === this.mode;
      }

      isCreateMode() {
        return (this.mode === this.modes.EDIT) && !this.user.id;
      }

      resetFormState() {
        this.editInProgress(false);
        let isNewUserCard = !this.user.id;
        let isUserEditCard = this.user.id;

        if (isUserEditCard) {
          this.toggleMode();
        }

        if (isNewUserCard) {
          this.clearNewUserForm();
        }

        this.resetAllMessages();
      }

      resetAllMessages() {
        this.displayEmailFormatMessage = false;
        this.displayPhoneFormatMessage = false;
      }

      save(e) {
        e.preventDefault();

        let user = Object.assign({}, this.user);

        if (user.id) {
          database.editUser(user);
        } else {
          database.saveUser(user);
        }
        if (!this.user.id) {
          this.cancel(e);
        } else {
          this.toggleMode();
          this.editInProgress(false);
        }
      }

      toggleMode(e) {
        this.mode = this.isMode(this.modes.EDIT) ? this.modes.DISPLAY : this.modes.EDIT;
        this.toggleEditable();
      }

      toggleEditable() {
        this.shadowRoot.querySelectorAll('input')
          .forEach(input => {
            input.readOnly = this.isMode(this.modes.DISPLAY);
          });
      }

      toggleNewUserCardDisplay() {
        let card = this.shadowRoot.querySelector('#userCard');
        let classToAdd = card.className.match(/\s?hidden/) ? 'visible' : 'hidden';
        let classToRemove = card.className.match(/\s?hidden/) ? 'hidden' : 'visible';
        this.toggleClass(card, classToAdd, classToRemove);
        if (classToAdd === 'hidden') {
          this.cancel();
        }
        this.setHeaderMessage();
      }
      setHeaderMessage() {
        let isExpanded = /\s?visible/;
        this.headerMessage = isExpanded.test(this.shadowRoot.querySelector('#userCard').className) ? `^` : 'Create User';
      }

      toggleClass(element, classToAdd, classToRemove) {
        let regexToAdd = new RegExp('\\s?' + classToAdd);
        let regexToReplace = new RegExp('\\s?' + classToRemove);
        let className = element.className;
        element.className = regexToReplace.test(className) ? className.replace(regexToReplace, ' ' + classToAdd) : className + ' ' + classToAdd;
      }

      toggleUserCardCollapse() {
        if (this.user.id) {
          let card = this.shadowRoot.querySelector('#userCard');
          let classToAdd = card.className.match(/collapsed/) ? 'user-card-expanded' : 'user-card-collapsed';
          let classToRemove = card.className.match(/collapsed/) ? 'user-card-collapsed' : 'user-card-expanded';
          this.toggleClass(card, classToAdd, classToRemove);
          this.toggleDetailsButtonContent(classToAdd);
        }
      }

      toggleDetailsButtonContent(state) {
        let buttonText = (state === 'user-card-expanded') ? 'x' : 'v';
        this.shadowRoot.querySelector('#detailsButton').innerHTML = '<p>' + buttonText + '</p>';
      }

      updateWarningMessages() {
        let isNewUser = !this.user.id;
        let emailInProgress = this.user.email;
        let phoneInProgress = this.user.phone;

        if (emailInProgress) {
          this.displayEmailFormatMessage = !ValidateUtil.checkEmailInput(this.user.email);
        }

        if (phoneInProgress) {
          this.displayPhoneFormatMessage = !ValidateUtil.checkPhoneInput(this.user.phone);
        }

        if (isNewUser) {
          this.displayOpenEditMessage = this.editOpen;
        }
      }

      whenEditOpenChanges() {
        this.formWatcher();
      }
    }

    customElements.define(UserComponentElement.is, UserComponentElement);
    export default UserComponentElement;
  </script>
</dom-module>
