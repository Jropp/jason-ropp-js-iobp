<!-- bplint-disable no-unused-import -->
<link rel="import" href="~@banno/polymer/lib/elements/dom-if.js">
<link rel="import" href="~@banno/polymer/polymer-element.js">
<link rel="import" href="../design/svgs/jha-add-person-icon.html">
<link rel="import" href="../design/svgs/jha-cancel-icon.html">
<link rel="import" href="../design/svgs/jha-department-icon.html">
<link rel="import" href="../design/svgs/jha-drop-arrow-icon.html">
<link rel="import" href="../design/svgs/jha-email-icon.html">
<link rel="import" href="../design/svgs/jha-person-icon.html">
<link rel="import" href="../design/svgs/jha-phone-icon.html">
<link rel="import" href="../design/svgs/jha-up-arrow-icon.html">
<!-- bplint-enable no-unused-import -->

<dom-module id="user-component">
  <link rel="stylesheet" href="./user-component.css">
  <template>

    <style>
      :host {
        font-family: Arial, Helvetica, sans-serif;
      }

      .default-card {
        position: relative;
        text-align: center;
        margin: 1em auto;
        padding-bottom: 30px;
        max-height: 750px;
        transition: max-height 0.5s ease-out;
      }

      .create-user-button {
        top: 0px;
        font-size: 20px;
        width: 100%;
        height: 90px;
        margin: 0;
        transition: background-color .2s;
      }

      .create-user-button:hover>jha-add-person-icon {
        fill: #0070b7;
      }

      form {
        margin: auto;
        width: 370px;
      }

      .first-name,
      .last-name {
        width: 38%;
        margin-top: 20px;
        font-size: 20px;
        display: inline-block;
        margin-right: 4%;
      }

      .first-name {
        position: relative;
        left: 11px;
        margin-right: 4%;
      }

      input:not(.name) {
        width: 80%;
        margin-top: 20px;
        font-size: 20px;
        display: inline-block;
      }

      .edit-user-header {
        margin-bottom: 0px;
      }

      .id {
        margin-top: -25px;
      }

      .id>* {
        display: inline-block;
        font-size: 14px;
      }

      .submit-button-box {
        margin: auto;
      }

      .expand-details-clickable {
        background-color: #fca902;
        box-sizing: border-box;
        position: absolute;
        height: 25px;
        width: 100%;
        bottom: 0px;
        left: 0px;
        margin-top: 10px;
        cursor: pointer;
      }

      /* NEW USER TRANISTIONS */

      .expand-new-user {
        max-height: 800px;
        animation-fill-mode: forwards;
        transition: max-height .6s ease-in;
      }

      .expand-new-user>.card_header>.create-user-button {
        background-color: #0070b7;
        font-size: 20px;
        transition: all .5s;
        padding: 0px;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
      }

      .expand-new-user>.create-user-button>jha-add-person-icon {
        fill: white;
        transition: fill .5s;
      }

      .expand-new-user>.card_content {
        height: auto;
        animation: fade-in .7s;
      }

      .create-user-button>jha-cancel-icon {
        width: 70px;
        height: 49px;
        fill: white;
      }

      .create-user-button:hover>jha-cancel-icon {
        fill: #fca902;
      }

      .collapse-new-user {
        max-height: 60px;
      }

      .collapse-new-user>.card_content {
        visibility: hidden;
      }


      .collapse-new-user.card_content>form>* {
        visibility: hidden;
        opacity: 0;
        transition: all .2s;
      }

      /* EXISTING USER TRANSITIONS */

      .collapse-existing-user {
        height: 70px;
        padding: 10px 0px 30px 0px;
        transition: height .4s ease-out;
      }

      .collapse-existing-user>.card_content {
        height: 0px;
        visibility: hidden;
      }

      .collapse-existing-user>.card_header>.id {
        opacity: 0;
        visibility: hidden;
      }

      .expand-existing-user {
        height: 370px;
        padding: 10px 0px 30px 0px;
        transition: height .4s ease-in;
      }

      .expand-existing-user>.card_content {
        height: auto;
        animation: fade-in .7s;
      }

      .expand-existing-user>.card_header>.id {
        animation: fade-in .2s;
        visibility: visible;
      }

      .expand-existing-user>.card_footer>.expand-details-clickable {
        background-color: #0070b7;
        transition: all .5s;
        cursor: pointer;
      }

      /* Existing User Reset After User Is Deleted because of Dom-Repeat Class Recycling. */

      .collapse-existing-user-default {
        height: 70px;
        padding: 10px 0px 30px 0px;
      }

      .collapse-existing-user-default>.card_content>form {
        height: 0px;
        visibility: hidden;
      }

      .collapse-existing-user-default>.card_header>.id {
        opacity: 0;
        visibility: hidden;
      }

      @keyframes fade-in {
        0% {
          opacity: 0;
        }
        50% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }

      .expand-details-clickable:hover>jha-drop-arrow-icon {
        fill: white;
        transition: fill .3s;
      }

      .expand-details-clickable>jha-up-arrow-icon {
        fill: white;
        transition: fill .3s;
      }

      .expand-existing-user>jha-drop-arrow-icon {
        fill: white;
      }

      .expand-details-clickable:hover>jha-up-arrow-icon {
        fill: #fca902;
      }

      .collapse-existing-user>jha-up-arrow-icon {
        fill: black;
      }
    </style>

    <div id="userCard" class$="[[userCardClass]]">
      <header class="card_header">
        <template is="dom-if" if="[[isMode(modes.DISPLAY, mode)]]">
          <h1>[[user.last]], [[user.first]]</h1>
          <div class="id" id="id">
            <h3>ID:</h3>
            <p class="id">[[user.id]]</p>
          </div>
        </template>
        <template is="dom-if" if="[[isMode(modes.EDIT_EXISTING, mode)]]">
          <h1 class="edit-user-header">[[setEditUserHeader(user)]]</h1>
        </template>
        <template is="dom-if" if="[[isMode(modes.CREATE_NEW, mode)]]">
          <button id="addUserButton" on-click="showHideNewUserForm" class="create-user-button">

            <template is="dom-if" if="[[isClass(classes.COLLAPSE_NEW, userCardClass)]]">
              <jha-add-person-icon></jha-add-person-icon>
            </template>
            <template is="dom-if" if="[[isClass(classes.EXPAND_NEW, userCardClass)]]">
              <jha-cancel-icon></jha-cancel-icon>
            </template>

          </button>
        </template>
      </header>
      <div class="card_content">
        <form on-input="formWatcher" autocomplete="on">
          <!-- bplint-disable no-auto-binding -->
          <template is="dom-if" if="[[!isMode(modes.DISPLAY, mode)]]">
            <label for="firstName"></label>
            <jha-person-icon></jha-person-icon>
            <input id="firstName" type="text" class="first-name name" placeholder="First" autocomplete="given-name" value="{{user.first::change}}"
              required>

            <label for="lastName"></label>
            <input id="lastName" type="text" class="last-name name" placeholder="Last" autocomplete="family-name" value="{{user.last::change}}"
              required>
            <br>
          </template>

          <label for="email">
          </label>
          <jha-email-icon></jha-email-icon>
          <input id="email" type="email" on-blur="formWatcher" class="email" placeholder="Email" autocomplete="email" value="{{user.email::change}}"
            name="email" required>
          <br>

          <template is="dom-if" if="[[displayEmailWarning]]">
            <p class="warning">[[emailFormatMessage]]</p>
          </template>

          <label for="phone">
          </label>
          <jha-phone-icon></jha-phone-icon>
          <input id="phone" type="tel" on-blur="formWatcher" class="phone" placeholder="Phone" autocomplete="tel" value="{{user.phone::change}}"
            required>
          <br>

          <template is="dom-if" if="[[displayPhoneWarning]]">
            <p class="warning">[[phoneFormatMessage]]</p>
          </template>

          <label for="department"></label>
          <jha-department-icon></jha-department-icon>
          <input id="department" class="department" placeholder="Department" value="{{user.department::change}}" required/>

          <!-- bplint-enable no-auto-binding -->
          <div class="submit-button-box">

            <template is="dom-if" if="[[!isMode(modes.DISPLAY, mode)]]">
              <button class="save-button" on-click="save" type="submit" disabled="[[disableSave]]">Save</button>

              <template is="dom-if" if="[[isMode(modes.EDIT_EXISTING, mode)]]">
                <button on-click="delete" type="submit" formnovalidate>Delete</button>
              </template>

              <template is="dom-if" if="[[displayOpenEditMessage]]">
                <p class="warning">[[openEditMessage]]</p>
              </template>

            </template>
            <template is="dom-if" if="[[isMode(modes.DISPLAY, mode)]]">
              <button on-click="editButtonClicked" type="submit" disabled="[[editOpen]]">Edit</button>
            </template>
          </div>
        </form>
      </div>
      <footer class="card_footer">
        <template is="dom-if" if="[[isMode(modes.DISPLAY, mode)]]">
          <div id="detailsButton" on-click="toggleUserCardCollapse" class="expand-details-clickable">
            <template is="dom-if" if="[[isClass(classes.EXPAND_EXISTING, userCardClass)]]">
              <jha-up-arrow-icon></jha-up-arrow-icon>
            </template>
            <template is="dom-if" if="[[isClass(classes.COLLAPSE_EXISTING, userCardClass)]]">
              <jha-drop-arrow-icon></jha-drop-arrow-icon>
            </template>

          </div>
        </template>
      </footer>
    </div>
  </template>
  <script type="module">
    import { Element as PolymerElement } from '@banno/polymer/polymer-element.js'; // eslint-disable-line no-unused-vars
    import { database } from './../api/user-database.js';
    import ValidateUtil from './../api/utils.js';
    class UserComponentElement extends PolymerElement {
      static get is() { return 'user-component'; }
      static get properties() {
        return {
          // edit, display
          mode: {
            type: String,
          },
          modes: {
            type: Object,
            value: () => {
              return {
                DISPLAY: 'display',
                EDIT_EXISTING: 'edit',
                CREATE_NEW: 'create'
              };
            }
          },
          classes: {
            type: Object,
            value: () => {
              return {
                COLLAPSE_NEW: 'default-card collapse-new-user',
                COLLAPSE_EXISTING: 'default-card collapse-existing-user',
                COLLAPSE_DEFAULT: 'default-card collapse-existing-user-default',
                EXPAND_NEW: 'default-card expand-new-user',
                EXPAND_EXISTING: 'default-card expand-existing-user',
              };
            }
          },
          user: {
            type: Object,
            value: () => {
              return {
                first: '',
                last: '',
                phone: '',
                email: '',
                department: '',
                id: ''
              };
            }
          },
          disableSave: {
            type: Boolean,
            value: true,
          },
          editOpen: {
            type: Boolean,
            value: false,
            observer: 'formWatcher'
          },
          displayOpenEditMessage: {
            type: Boolean,
          },
          displayPhoneWarning: {
            type: Boolean,
          },
          displayEmailWarning: {
            type: Boolean,
          },
          openEditMessage: {
            type: String,
            value: 'You are safe to save this once the other open edits are closed.'
          },
          phoneFormatMessage: {
            type: String,
            value: 'Would you mind formatting your number as (xxx) xxx-xxxx?'
          },
          emailFormatMessage: {
            type: String,
            value: 'Your email seems a little off. Would you mind formatting it as xxxx@xxxxx.xxx?'
          },
          // passed in from parent of user-component
          userToDisplay: {
            type: Object,
            observer: 'formatIncomingUserData'
          },
          userCardClass: {
            type: String,
            value: 'default-card collapse-new-user'
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.initCardState();
      }

      initCardState() {
        let isExistingUser = Boolean(this.user.id);

        if (isExistingUser) {
          this.mode = this.modes.DISPLAY;
          this.toggleEditableInputs();
          this.userCardClass = this.classes.COLLAPSE_EXISTING;
        } else {
          this.mode = this.modes.CREATE_NEW;
        }
      }

      formatIncomingUserData(user) {
        user.phone = ValidateUtil.insertPhoneSymbols(user.phone);
        this.user = user;
      }

      save(e) {
        e.preventDefault();

        let user = Object.assign({}, this.user);

        if (this.isMode(this.modes.CREATE_NEW)) {
          database.saveUser(user);
        } else {
          database.editUser(user);
        }

        this.resetFormState();
        this.editInProgress(false);

      }

      delete(e) {
        e.preventDefault();
        database.deleteUser(this.user);
        this.editInProgress(false);
        this.mode = this.modes.DISPLAY;
        this.userCardClass = this.classes.COLLAPSE_DEFAULT;
        this.toggleUserCardButtonIcon();
        this.toggleEditableInputs();
        this.clearFormatWarningMessages();
      }

      cancel() {
        this.resetNewUserForm();
      }

      formWatcher() {
        this.updateDisableSaveButton();
        this.updateWarningMessageDisplay();
      }

      updateDisableSaveButton() {
        let editOpenAndNewUser = this.editOpen && this.isMode(this.modes.CREATE_NEW);
        let emptyFields = !this.areFieldsFilled();
        let improperPhoneFormat = !ValidateUtil.checkPhoneInput(this.user.phone);
        let improperEmailFormat = !ValidateUtil.checkEmailInput(this.user.email);

        this.disableSave = editOpenAndNewUser || emptyFields || improperPhoneFormat || improperEmailFormat;
      }

      updateWarningMessageDisplay() {
        let isNewUserCard = this.isMode(this.modes.CREATE_NEW);
        let emailInProgress = this.user.email;
        let phoneInProgress = this.user.phone;

        this.displayEmailWarning = emailInProgress && !ValidateUtil.checkEmailInput(this.user.email);
        this.displayPhoneWarning = phoneInProgress && !ValidateUtil.checkPhoneInput(this.user.phone);
        this.displayOpenEditMessage = isNewUserCard && this.editOpen;

        let errorMessageDisplayed = this.displayEmailWarning || this.displayPhoneWarning || this.displayOpenEditMessage;

        if (errorMessageDisplayed) {
          this.resizeCardForWarningMessages(true);
        }
      }

      clearFormatWarningMessages() {
        this.displayEmailWarning = false;
        this.displayPhoneWarning = false;
        this.resizeCardForWarningMessages(false);
      }

      areFieldsFilled() {
        let fields = this.shadowRoot.querySelectorAll('input');
        let fieldsFilled = true;

        fields.forEach(field => {
          if (!field.value.length) {
            fieldsFilled = false;
            return; // eslint-disable-line no-useless-return
          }
        });

        return fieldsFilled;
      }

      toggleUserCardCollapse() {
        let collapsed = this.classes.COLLAPSE_EXISTING;
        let expanded = this.classes.EXPAND_EXISTING;
        let resetAfterDelete = this.classes.COLLAPSE_DEFAULT;

        let isCollapsed = (this.isClass(resetAfterDelete) || this.isClass(collapsed));

        this.userCardClass = isCollapsed ? expanded : collapsed;

        this.toggleUserCardButtonIcon();
      }

      toggleUserCardButtonIcon() {
        let button = this.shadowRoot.querySelector('#detailsButton');
        let upArrowIcon = '<jha-up-arrow-icon></jha-up-arrow-icon>';
        let dropArrowIcon = '<jha-drop-arrow-icon></jha-drop-arrow-icon>';

        let isCollapsed = (this.isClass(this.classes.COLLAPSE_DEFAULT) || this.isClass(this.classes.COLLAPSE_EXISTING));

        button.innerHTML = isCollapsed ? dropArrowIcon : upArrowIcon;
      }

      editButtonClicked(e) {
        e.preventDefault();
        this.editInProgress(true);
        this.mode = this.modes.EDIT_EXISTING;
        this.toggleEditableInputs();
      }

      setEditUserHeader() {
        return `Edit: ${this.user.last}, ${this.user.first}`;
      }

      editInProgress(bool) {
        this.dispatchEvent(new CustomEvent('editInProgress', {
          bubbles: true,
          composed: true,
          detail: bool
        }));
      }

      toggleEditDisplayMode(e) {
        this.mode = this.isMode(this.modes.EDIT_EXISTING) ? this.modes.DISPLAY : this.modes.EDIT_EXISTING;
      }

      toggleEditableInputs() {
        this.shadowRoot.querySelectorAll('input')
          .forEach(input => {
            input.readOnly = this.isMode(this.modes.DISPLAY);
          });
      }

      resetFormState() {
        this.editInProgress(false);

        if (this.isMode(this.modes.EDIT_EXISTING)) {
          this.toggleEditDisplayMode();
          this.toggleEditableInputs();
        } else {
          this.showHideNewUserForm();
          this.resetNewUserForm();
        }

        this.clearFormatWarningMessages();
      }

      showHideNewUserForm() {
        let collapsed = this.classes.COLLAPSE_NEW;
        let expanded = this.classes.EXPAND_NEW;

        this.userCardClass = this.isClass(collapsed) ? expanded : collapsed;

        if (this.isClass(collapsed)) {
          this.resetNewUserForm();
        }
      }

      toggleNewUserIcon() {
        let button = this.shadowRoot.querySelector('#addUserButton');
        let expanded = this.classes.EXPAND_NEW;

        let cancelIcon = '<jha-cancel-icon></jha-cancel-icon>';
        let addPersonIcon = '<jha-add-person-icon></jha-add-person-icon>';

        let buttonIcon = this.isClass(expanded) ? cancelIcon : addPersonIcon;
        button.innerHTML = buttonIcon;
      }

      resetNewUserForm() {
        this.shadowRoot.querySelector('form').reset();
        this.clearFormatWarningMessages();
      }

      resizeCardForWarningMessages(expandForMessages) {
        if (expandForMessages) {
          this.$.userCard.style.height = 'auto';
        } else {
          this.$.userCard.style = '';
        }
      }

      isMode(expectedMode) {
        return expectedMode === this.mode;
      }

      isClass(expectedClass) {
        return expectedClass === this.userCardClass;
      }

    }

    customElements.define(UserComponentElement.is, UserComponentElement);
    export default UserComponentElement;
  </script>
</dom-module>
