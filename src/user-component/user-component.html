<!-- User component card has three settings mode="display" mode="edit" mode="create"
  <user-component mode="display"> Displays the user passed into it.

  <user-component mode="edit"> Brings up autofilled input boxes with the current users information
    change and submit the data to update the users information

  <user-component mode="create"> Opens up a form to enter a new users information. This box auto-generates a 9 character id
-->

<link rel="import" href="polymer.html">
<dom-module id="user-component">
	<template>
		<style>
			:host {
				display: block;
			}

			.default-card {
				background-color: #B1A296;
				min-width: 300px;
				width: fit-content;
				padding: 15px;
				margin: 5px;
				border-radius: 5px;
				box-shadow: 3px 3px 2px lightgrey;
			}

			.default-card>input .first-name .last-name {
				width: 20px;
			}
		</style>
		<template is="dom-if" if="[[!edit]]">
			<hgroup class="default-card" on-click="toggleCollapse">
				<h2 class="name">[[user.first]] [[user.last]]</h2>
				<template is="dom-if" if="[[!collapsed]]">
					<h3 class="id">ID: [[user.id]]</h3>
					<h3 class="phone">[[user.phone]]</h3>
					<h3 class="email">
						<a href="dummy@email.com">[[user.email]]</a>
					</h3>
					<h3 class="department">
						[[user.department]]
					</h3>
					<button on-click="toggleView">Edit User</button>
				</template>
			</hgroup>
		</template>
		<template is="dom-if" if="[[edit]]">
			<div class="form-box">
				<form autocomplete="on">
					<div id="editUserFields" class="default-card">
						<h5>Name:</h5>
						<input id="fName" type="text" class="input first-name" autocomplete="given-name" value="[[user.first]]" required>
						<input id="lName" type="text" class="input last-name" autocomplete="family-name" value="[[user.last]]" required>
						<h5>Email:</h5>
						<input id="email" type="email" class="input" autocomplete="email" value="[[user.email]]" name="email" required>
						<h5>Phone:</h5>
						<input id="phone" type="tel" class="input" autocomplete="tel" value="[[user.phone]]" required>
						<h5>Department:</h5>
						<input id="department" class="input" value="[[user.department]]" required>
					</div>
					<div class="submit-button-box">
						<button class="form-button" on-click="save" type="submit">Submit</button>
						<button class="form-button" on-click="deleteUser" type="submit">Delete</button>
					</div>
				</form>
			</div>
		</template>
	</template>
	<script>
		'use strict';
		class UserComponent extends Polymer.Element {
			static get is() { return 'user-component'; }
			static get properties() {
				return {
					edit: {
						type: Boolean,
						value: false
					},
					collapsed: {
						type: Boolean,
						value: false,
						observer: 'collapseDetails'
					},
					user: {
						type: Object,
					},
					userBeforeEdit: {
						type: Object
					}
				};
			}
			ready() {
				super.ready();


			}

			// Makes sure all fields are filled
			checkFields(user) {
				for (let prop in user) {
					if (!user[prop]) {
						window.alert('Please fill out highlighted fields');
						return false;
					}
				}
				return true;
			}

			createNewUserId() {
				let id = [];

				// returns 9 random letters/symbols/numbers and pushes them into the id.
				for (let i = 0; i < 9; i++) { // eslint-disable-line no-magic-numbers
					let number = Math.random() * (94); // eslint-disable-line no-magic-numbers
					id.push(String.fromCharCode(Math.floor(number + 33))); // eslint-disable-line no-magic-numbers
				}
				id = id.join('');

				// Checks to make sure id is not already in use
				if (this.getIdIndex(id)) {
					this.createNewUserId();
				} else {
					return id;
				}
			}

			compileUserFormData(e) {


				let user = {
					first: this.shadowRoot.querySelector('#fName').value,
					last: this.shadowRoot.querySelector('#lName').value,
					phone: this.shadowRoot.querySelector('#phone').value,
					email: this.shadowRoot.querySelector('#email').value,
					department: this.shadowRoot.querySelector('#department').value
				};

				return user;
			}


			deleteUser() {
				let users = this.getUsers();
				let userIndex = this.getIdIndex(this.user.id);

				users.splice(userIndex, 1);
				this.saveToLocalStorage(users);
				this.showUserDisplay();
			}

			emptyNewUserForm() {

			}

			getIdIndex(id) {
				let users = this.getUsers();

				let index = (users) ? users.findIndex(val => val.id === id) : -1;

				// Returns false if id does not exist
				return (index === -1) ? false : index;
			}

			getUsers() {
				let users = JSON.parse(localStorage.getItem('onboardProjectUsers'));

				// checks to see if array has users, if not, inits a users aray
				if (!users) {
					users = [];
				}
				return users;
			}

			save(e) {
				e.preventDefault();
				let user = (this.user) ? this.user : this.compileUserFormData(e);

				let users = this.getUsers();
				let fieldsFilled = this.checkFields(user);

				if (fieldsFilled) {
					// if new user
					if (user.id === undefined) {
						user.id = this.createNewUserId();
						users.push(user);

						let fields = this.shadowRoot.querySelector('#editUserFields').children;
						for (let field of fields) {
							field.value = '';
						}
						// if existing user
					} else {
						let index = this.getIdIndex(user.id);
						users.splice(index, 1, user);
						// Updates the information displayed on the user card so when you close the edit window it displays properly
						this.user = user;
						this.toggleView();
					}

					this.saveToLocalStorage(users);


					if (this.collapsed) {
						this.toggleCollapse();
					}
				}
			}

			saveToLocalStorage(users) {
				localStorage.setItem('onboardProjectUsers', JSON.stringify(users));
			}

			toggleCollapse() {
				this.collapsed = this.collapsed !== true;
			}

			toggleView() {
				this.edit = (!this.edit) ? true : false;
			}
		}

		customElements.define(UserComponent.is, UserComponent);
	</script>
</dom-module>
