<link rel="import" href="polymer.html">
<dom-module id="user-component">
	<template>
		<style>
			:host {
				display: block;
				padding: 10px;
			}

			.default-card {
				background-color: #B1A296;
				min-width: 300px;
				width: fit-content;
				padding: 15px;
				margin: 5px;
				border-radius: 5px;
				box-shadow: 3px 3px 2px lightgrey;
			}



			.default-card>input .first-name .last-name {
				width: 20px;
			}



			/*
      form {
        margin-top: 20px;
        width: 140px;
      }

      .form-box {
        padding: 10px;
        width: 400px;
      }

      .form-box input,
      .form-button {
        display: block;
        margin: 10px;
        border-radius: 3px;
        width: 80%;
      }

      .form-button {
        display: block;
        margin: 10px;
        margin-left: 20px;
      }

      .heading {
        position: relative;
        left: -10px;
        margin: 10px;
      }

      .submit-button-box {
        width: fit-content;
        border-radius: 3px;
        min-width: 200px;
      }

      .contact-info-header {
        font-size: 12px;
        font-weight: bold;
        margin: 5px;
        margin-left: 10px;
        margin-right: 10px;
        border-top: 1px solid rgb(94, 94, 94);
        border-bottom: 1px solid rgb(94, 94, 94);
        text-align: center;

      }

      .new-user-fields {
        box-shadow: 1px 1px 4px #dadada;
        background-color: #B1A296;
        padding: 10px;
        width: fit-content;
        border-radius: 3px;
        min-width: 200px;
      }

      .default-card:hover {
        height: 230px;
        transition: height .4s ease-out;
      }

      .default-card:not(:hover) {
        height: 50px;
        transition: height .4s ease-in;
      }

      .default-card:hover>h3 {
        opacity: 1;
        transition: opacity 1.4s;
      }

      .default-card>h3 {
        opacity: 0;
      }

      button {
        background-color: #7395AE;
        color: black;
        border: none;
      } */
		</style>
		<template is="dom-if" if="[[create]]">
			<div class="form-box">
				<div class="heading">Add New User:</div>
				<form autocomplete="on" class="default-card">
					<div id="newUserFields" class="new-user-fields">
						<input id="id" type="text" class="input" autocomplete="username" placeholder="User Id" required>
						<input id="fName" type="text" class="input first-name" autocomplete="given-name" placeholder="First Name" required>
						<input id="lName" type="text" class="input last-name" autocomplete="family-name" placeholder="Last Name" required>
						<input id="email" type="email" class="input" autocomplete="email" placeholder="Email" name="email" required>
						<input id="phone" type="tel" class="input" autocomplete="tel" placeholder="Phone" required>
						<input id="department" class="input" placeholder="department" required>
					</div>
					<div class="submit-button-box">
						<button class="form-button" on-click="createUser" type="submit">Submit</button>
					</div>
				</form>
			</div>
		</template>
		<template is="dom-if" if="[[display]]">
			<hgroup class="default-card">
				<h2 class="name">[[user.first]] [[user.last]]</h2>
				<template is="dom-if" if="[[!collapsed]]">
					<h3 class="id">ID: [[user.id]]</h3>
					<h3 class="phone">[[user.phone]]</h3>
					<h3 class="email">
						<a href="dummy@email.com">[[user.email]]</a>
					</h3>
					<button on-click="editUserDisplay">Edit User</button>
				</template>
				<template is="dom-if" if="[[admin]]">
					<button on-click="[[editUserDisplay]]">Edit User Details</button>
				</template>
			</hgroup>
		</template>
		<template is="dom-if" if="[[edit]]">
			<div class="form-box">
				<form autocomplete="on">
					<div id="editUserFields" class="default-card">
						<h5>Name:</h5>
						<input id="editFName" type="text" class="input first-name" autocomplete="given-name" value="[[user.first]]" required>
						<input id="editLName" type="text" class="input last-name" autocomplete="family-name" value="[[user.last]]" required>
						<h5>Id:</h5>
						<p id="editId" value="[[user.id]]">[[user.id]]</p>
						<h5>Email:</h5>
						<input id="editEmail" type="email" class="input" autocomplete="email" value="[[user.email]]" name="email" required>
						<h5>Phone:</h5>
						<input id="editPhone" type="tel" class="input" autocomplete="tel" value="[[user.phone]]" required>
						<h5>Department:</h5>
						<input id="editDepartment" class="input" value="[[user.department]]" required>
					</div>
					<div class="submit-button-box">
						<button class="form-button" on-click="saveUserEdit" type="submit">Submit</button>
					</div>
				</form>
			</div>
		</template>
	</template>
	<script>
		'use strict';
		class UserComponent extends Polymer.Element {
			static get is() { return 'user-component'; }
			static get properties() {
				return {
					edit: {
						type: Boolean,
						value: false
					},
					create: {
						type: Boolean,
						value: false
					},
					display: {
						type: Boolean,
						value: false
					},
					collapsed: {
						type: Boolean,
						value: false,
						observer: 'collapseDetails'
					},
					user: {
						type: Object,
						observer: 'confirm'
					},
					userBeforeEdit: {
						type: Object
					},
					mode: {
						type: String,
						observer: 'changeMode'
					}
				};
			}
			ready() {
				super.ready();
				// Temporary to get a placeholder value. Later on this will be a databound attribute in the parent
				// let users = JSON.parse(localStorage.getItem('onboardProjectUsers'));
				// let user = users[0];
				// this.set('user', user);

				// Check for users and initialize if not present
			}
			confirm() {
				console.log(this.user);

			}

			createNewUserId() {
				let id = [];
				// returns 9 random letters/symbols/numbers and pushes them into the id.
				for (let i = 0; i < 9; i++) { // eslint-disable-line no-magic-numbers
					let number = String.fromCharCode(Math.random() * (127 - 1)); // eslint-disable-line no-magic-numbers
					id.push(Math.floor(number) + 1);
				}
				// Sets the user id to be the combination of random numbers
				id = id.join();

				// Checks to make sure id is not already in use
				if (this.getIdIndex(id)) {
					this.createNewUserId();
				} else {
					return id;
				}

			}

			getIdIndex(id) {
				let users = this.getUsers();
				for (let [index, user] of users) {
					if (user.id === id) {
						return index;
					}
				}
				return false;
			}

			saveNewUser() {
				let user = this.compileUserData();
				// Gives the new user a unique autogenerated id
				user.id = this.createNewUserId();
				let users = this.getUsers();
				users.push(user);
				this.saveToLocalStorage(users);
				this.emptyNewUserForm();
			}

			saveUserEdit() {
				let user = this.compileEditUserFormData();
				let users = this.getUsers();

				// Do I even need to do this? Doesn't it do it automatically?
				let fieldsFilled = this.checkFields(user);

				if (fieldsFilled) {
					for (let i = 0; i < users.length; i++) {
						const item = users[i];
						if (item.id === user.id) {
							users.splice(i, 1, user);
							this.saveToLocalStorage(users);
							return;
						}
					}
				}
			}

			compileUserFormData() {
				let user = {
					first: this.$.fName.value,
					last: this.$.lName.value,
					phone: this.$.phone.value,
					email: this.$.email.value,
					id: this.$.id.value,
					department: this.$.department.value
				};
				this.checkFields(user);

				return user;
			}
			compileEditUserFormData() {
				let user = {
					first: this.shadowRoot.querySelector('#editFName').value,
					last: this.shadowRoot.querySelector('#editLName').value,
					phone: this.shadowRoot.querySelector('#editPhone').value,
					email: this.shadowRoot.querySelector('#editEmail').value,
					id: this.shadowRoot.querySelector('#editId').value,
					department: this.shadowRoot.querySelector('#editDepartment').value
				};
				this.checkFields(user);

				return user;
			}

			createNewUser(e) {
				e.preventDefault();
				let user = this.compileUserData();
				this.saveUser(user);
			}

			getUsers() {
				return JSON.parse(localStorage.getItem('onboardProjectUsers'));
			}

			saveToLocalStorage(users) {
				localStorage.setItem('onboardProjectUsers', JSON.stringify(users));
			}
			// Makes sure all fields are filled
			checkFields(user) {
				for (let prop in user) {
					if (!user[prop]) {
						this.highlightEmptyFields();
						window.alert('Please fill out highlighted fields');
						return false;
					}
				}

				return true;
			}

			highlightEmptyFields() {
				let fields = this.$.newUserFields.children;
				for (let field of fields) {
					if (!field.value) {
						field.style.backgroundColor = 'lightblue';
					}
				}
			}

			emptyNewUserForm() {
				let fields = this.$.newUserFields.children;
				for (let field of fields) {
					field.value = '';
				}
			}

			changeMode() {
				switch (this.mode) {
					case 'edit':
						this.editUserDisplay();
						break;
					case 'create':
						this.createUserDisplay();
						break;
					case 'display':
						this.showUserDisplay();
						break;
					default:
						break;
				}
			}

			editUserDisplay() {
				this.userBeforeEdit = this.user;
				this.edit = true;
				this.display = false;
				this.create = false;
			}

			createUserDisplay() {
				this.edit = false;
				this.display = false;
				this.create = true;
			}

			showUserDisplay() {
				this.edit = false;
				this.display = true;
				this.create = false;
			}


		}

		customElements.define(UserComponent.is, UserComponent);
	</script>
</dom-module>
