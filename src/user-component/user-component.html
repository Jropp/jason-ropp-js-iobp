<!-- bplint-disable no-unused-import -->
<link rel="import" href="~@banno/polymer/lib/elements/dom-if.js">
<link rel="import" href="~@banno/polymer/polymer-element.js">
<!-- bplint-enable no-unused-import -->

<dom-module id="user-component">
  <template>
    <style>
      :host {
        display: block;
      }

      .default-card {
        width: fit-content;
        min-width: 500px;
        min-height: 400px;
        margin: 5px;
        padding: 15px;
        border: #7395ae 1px solid;
        border-radius: 5px;
        box-shadow: 3px 3px 2px lightgrey;
        background-color: white;
      }

      fieldset {
        margin: 10px;
        border: #7395ae 2px solid;
        border-radius: 3px;
      }

      .default-card>input .first-name .last-name {
        width: 20px;
      }

      input {
        margin: 5px;
        border: none;
        font-size: 20px
      }

      .edit {
        border-bottom: lightgray solid 1px;
      }

      .email {
        width: 50%;
      }

      .id {
        font-size: 20px;
      }

      button {
        margin: 10px;
        width: 60px;
        height: 30px;
        border-radius: 3px;
        background-color: #7395ae;
      }

      .warning {
        color: red;
        font-size: 20px;
      }
    </style>

    <div id="editUserFields" class="default-card">
      <form autocomplete="on">
        <h1>[[headerMessage(mode)]]</h1>
        <template is="dom-if" if="[[isMode(mode, modes.EDIT)]]">
          <p class="warning">[[warningMessage]]</p>
        </template>
        <!-- bplint-disable no-auto-binding -->
        <template is="dom-if" if="[[isMode(mode, modes.EDIT)]]">
          <fieldset>
            <label for="firstName">First:</label>
            <input id="firstName" type="text" class="first-name edit" placeholder="First" autocomplete="given-name" value="{{user.first::change}}"
              required>

            <label for="lastName">Last:</label>
            <input id="lastName" type="text" class="last-name edit" placeholder="Last" autocomplete="family-name" value="{{user.last::change}}"
              required>
          </fieldset>
        </template>
        <template is="dom-if" if="[[isMode(mode, modes.DISPLAY)]]">
          <h1>[[user.last]], [[user.first]]</h1>
          <p class="warning">[[warningMessage]]</p>
        </template>

        <fieldset>
          <label for="email">Email:</label>
          <input id="email" type="email" class="email edit" placeholder="email" autocomplete="email" value="{{user.email::change}}"
            name="email" required>
          <br>

          <label for="phone">Phone:</label>
          <input id="phone" type="tel" class="phone edit" placeholder="(xxx) xxx-xxxx" autocomplete="tel" value="{{user.phone::change}}"
            required>
          <br>

          <label for="department">Department:</label>
          <input id="department" class="department edit" placeholder="Department" value="{{user.department::change}}" required/>
        </fieldset>

        <template is="dom-if" if="[[user.id]]">
          <fieldset>
            <div id="id">
              <h3>ID:</h3>
              <p class="id">[[user.id]]</p>
            </div>
          </fieldset>
        </template>
        <!-- bplint-enable no-auto-binding -->
        <div class="submit-button-box">

          <template is="dom-if" if="[[isMode(mode, modes.EDIT)]]">
            <button on-click="normalizeUserInfo" type="submit">Save</button>

            <template is="dom-if" if="[[!user.id]]">
              <button on-click="cancel" formnovalidate>Cancel</button>
            </template>

            <template is="dom-if" if="[[user.id]]">
              <button on-click="delete" type="submit" formnovalidate>Delete</button>
            </template>

          </template>

          <template is="dom-if" if="[[isMode(mode, modes.DISPLAY)]]">
            <button on-click="editButtonClicked" type="submit">Edit</button>
          </template>

        </div>
      </form>
    </div>
  </template>
  <script type="module">
    import { Element as PolymerElement } from '@banno/polymer/polymer-element.js'; // eslint-disable-line no-unused-vars
    class UserComponentElement extends PolymerElement {
      static get is() { return 'user-component'; }
      static get properties() {
        return {
          // edit, display
          mode: {
            type: String,
            observer: 'toggleEditable'
          },
          modes: {
            type: Object,
            value: () => {
              return {
                DISPLAY: 'display',
                EDIT: 'edit'
              };
            }
          },
          user: {
            type: Object,
            value: () => {
              return {
                first: '',
                last: '',
                phone: '',
                email: '',
                department: '',
                id: ''
              };
            }
          },
          disableSave: {
            type: Boolean,
            value: false,
            observer: 'setWarningMessage'
          },
          disableEdit: {
            type: Boolean,
            value: false,
            observer: 'setWarningMessage'
          },
          warningMessage: {
            type: String
          }
        };
      }

      normalizeUserInfo(e) {
        e.preventDefault();

        if (this.checkPhoneFormat(this.user.phone)) {
          this.user.phone = this.normalizePhoneNumber(this.user.phone);
        } else {
          window.alert('Please format number as (xxx) xxx-xxxx');
          return;
        }

        this.save();
      }

      save(e) {

        let validatedUserToSave = Object.assign({}, this.user);

        if (this.validateSave()) {

          if (!this.user.id) {
            this.clearInputForm();
          } else {
            this.toggleMode();
          }

          this.dispatchEvent(new CustomEvent('save', {
            bubbles: true,
            composed: true,
            detail: { user: validatedUserToSave }
          }));
        }
      }

      checkPhoneFormat(phone) {
        let optCountryCode = '(^\\d{1,3})?';
        let optDash = '[-\\s]?';
        let areaCode = '(^)?\\(?\\d{3}\\)?';
        let threeDigit = '\\d{3}';
        let fourDigit = '\\d{4}';
        let phoneFormat = new RegExp(optCountryCode + optDash + areaCode + optDash + threeDigit + optDash + fourDigit);

        return phoneFormat.test(phone);
      }

      normalizePhoneNumber(phone) {
        let numbers = this.extractPhoneNumbers(phone);
        return this.formatPhoneNumber(numbers);
      }

      extractPhoneNumbers(formInput) {
        let numbers = [];
        let isDigit = /\d/;

        for (let char of formInput) {
          if (isDigit.test(char)) {
            numbers.push(char);
          }
        }

        return numbers;
      }

      formatPhoneNumber(phoneArray) {
        phoneArray = phoneArray.reverse();
        let domesticSymbols = {
          dash: { loc: 4, text: '-' },
          spaceLoc: { loc: 8, text: ' ' },
          leftParLoc: { loc: 9, text: ')' },
          rightParLoc: { loc: 13, text: '(' },

        }

        Object.keys(symbols).forEach(symbol => {
          phoneArray.splice(symbol.loc, 0, symbol.text)
        });

        let domesticNumLength = 14;
        let interSpaceLoc = 14;
        if (phoneArray.length > domesticNumLength) {
          phoneArray.splice(interSpaceLoc, 0, ' ');

          let internationalNumPre = '+';
          phoneArray.push(internationalNumPre);
        }

        phoneArray = phoneArray.reverse();
        return phoneArray.join('');
      }

      clearInputForm() {

        this.shadowRoot.querySelector('form').reset();
        this.setWarningMessage('');

        for (let key of Object.keys(this.user)) {
          this.user[key] = '';
        }

      }

      validateSave() {
        if (this.disableSave) {
          this.setWarningMessage('Please save user edits first.');
          // window.alert('Please save user edits first.');
          return false;
        }

        // Makes sure fields are filled
        for (let key of Object.keys(this.user)) {
          if (!this.user[key].length) {
            if (key !== 'id') {
              this.setWarningMessage('Please fill out all fields.');
              // window.alert('Please fill out all fields.');
              return false;
            }
          }
        }
        return true;
      }

      validatePhoneNumber() { }

      cancel(e) {
        e.preventDefault();
        this.dispatchEvent(new CustomEvent('cancel', {
          bubbles: true,
          composed: true,
        }));

        this.shadowRoot.querySelector('form').reset();
      }

      delete(e) {
        e.preventDefault();

        this.dispatchEvent(new CustomEvent('delete', {
          bubbles: true,
          composed: true,
          detail: { user: this.user }
        }));

        this.mode = this.modes.DISPLAY;
      }

      isMode(currentMode, expectedMode) {
        return (currentMode === expectedMode);
      }

      headerMessage(mode) {
        if (mode === this.modes.EDIT) {
          return this.user.id ? `Edit: ${this.user.first}, ${this.user.last}` : 'Create User:';
        }
        return '';
      }

      setWarningMessage(message) {
        // if (message === Boolean) {
        //   this.warningMessage = '';
        // }
        this.warningMessage = (typeof message === 'boolean') ? '' : message;
      }

      editButtonClicked(e) {
        e.preventDefault();

        if (this.disableEdit) {
          this.setWarningMessage('Please save user edits first.');
          return;
        }

        this.dispatchEvent(new CustomEvent('edit', {
          bubbles: true,
          composed: true
        }));

        this.toggleMode();
      }

      toggleMode(e) {
        this.mode = this.isMode(this.mode, this.modes.EDIT) ? this.modes.DISPLAY : this.modes.EDIT;
      }

      toggleEditable() {

        this.shadowRoot.querySelectorAll('input')
          .forEach(field => {
            field.readOnly = this.isMode(this.mode, this.modes.DISPLAY);
            let name = field.className;
            field.className = this.isMode(this.mode, this.modes.DISPLAY) ? name.replace(/edit/, '') : name + ' edit';
          });
      }
    }

    customElements.define(UserComponentElement.is, UserComponentElement);
    export default UserComponentElement;
  </script>
</dom-module>
